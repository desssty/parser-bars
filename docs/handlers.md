# Документация к handler/form.py

## Описание файла

`form.py` содержит хендлеры и вспомогательные функции для взаимодействия с пользователем через Telegram.  
Основная цель — реализовать функционал поиска резюме и отслеживания вакансий с помощью интерактивных меню и состояний FSM.

---

## Функции для работы с JSON

- **load_tracks()**  
  Загружает список отслеживаемых вакансий из файла `time.json`.  
  Если файл не существует или возникает ошибка — возвращает пустой список.

- **save_tracks(data)**  
  Сохраняет переданный список вакансий в `time.json`.

---

## Клавиатуры

- **get_main_keyboard()**  
  Создаёт основное меню с кнопками "Начать новый поиск" и "Отслеживать".

- **get_tracking_keyboard()**  
  Создаёт меню отслеживания с кнопками "Добавить", "Список", "Удалить" и "Назад".

---

## Вспомогательные функции меню

- **show_main_menu(message, bot)**  
  Отображает основное меню пользователю.

- **show_tracking_menu(message, bot)**  
  Отображает меню отслеживания пользователю.

- **send_data_to_url(data)**  
  Асинхронно отправляет JSON-данные на внешний URL, заданный в `EXTERNAL_URL`.

---

## Хендлеры Telegram

- **start(message, state, bot)**  
  Обрабатывает команду `/start`.  
  Очищает состояние FSM и отображает главное меню.

- **open_tracking(message, bot)**  
  Обрабатывает кнопку "Отслеживать".  
  Показывает меню отслеживания.

- **back_to_main(message, bot)**  
  Обрабатывает кнопку "Назад".  
  Возвращает пользователя в главное меню.

- **list_tracks_handler(message, bot)**  
  Обрабатывает кнопку "Список".  
  Показывает текущий список отслеживаемых вакансий.

- **add_track_start(message, state)**  
  Обрабатывает кнопку "Добавить" для отслеживания вакансии.  
  Запускает FSM для ввода названия вакансии.

- **add_track_vac(message, state)**  
  Получает название вакансии от пользователя и запрашивает город.

- **add_track_city(message, state, bot)**  
  Получает город, добавляет новую запись в файл отслеживания и возвращает меню отслеживания.

- **delete_track_start(message, state)**  
  Обрабатывает кнопку "Удалить".  
  Запрашивает ID вакансии для удаления.

- **delete_track_process(message, state, bot)**  
  Удаляет запись по ID и возвращает меню отслеживания.

- **start_search_flow(message, state)**  
  Обрабатывает кнопку "Начать новый поиск".  
  Запускает FSM для ввода вакансии.

- **get_vacancy(message, state)**  
  Сохраняет введённую пользователем вакансию и запрашивает город.

- **get_city(message, state, bot)**  
  Сохраняет город и запускает асинхронный процесс поиска резюме:
  - Запуск основного парсера HeadHunter
  - При недостаточном количестве результатов — запуск парсера Habr Career
  - Сохранение объединённых результатов в JSON
  - Отправка данных на внешний URL
  - Информирование пользователя о прогрессе и завершении поиска

---

## Особенности

- FSM используется для управления диалогом с пользователем.
- Асинхронный поиск выполняется в фоне с прогресс-индикатором.
- JSON-файлы `time.json` и `resume.json` используются для хранения состояния отслеживания и результатов поиска.
- Поддерживается интеграция с внешним API через `EXTERNAL_URL`.
